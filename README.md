# LGN
The folder contains IgorPro experiment and shell scripts designed for processing magnetic resonance images.
The procedure is the following:
1. Open MRI image in ITK-SNAP. Identify the center of LGN on sagittal slice. 


The protocol of the edge-enhancement consists of the following steps:

1.	Download shell scripts 
2.	Open MRI image with ITK-SNAP, find LGN in the sagittal view, put a crosshairs on the center of LGN in the sagittal view, put a coordinates of the cross-hairs as a shell script input : ./nameofthescript 88 88 88. The shell script should be in the same directory as MRI images. The output of the shell script is a text file xxx.txt. Repeat this for each MRI image to be processed.
3.	Open IgorPro experiment xxx.pxp. Download the text file(s) xxx.txt. Put the names of the files as an input argument in the function Ar2Im(), one by one. Run Ar2Im for each text file separately. The output of the function is the 22x22x22 image xxx.
4.	In IgorPro, type the name(s) of the 22x22x22 images obtained in the previous step into the table ImName. In the command line (command-J or Ctrl-J) run the command Batch(1,Nit), where the first argument is either 0 (larger set of the multiplane units to compare with) or 1 (smaller set of the multiplane units to compare with). Nit is the number of iterations. The estimated time to finish the job is 5-6 hours per image in the table ImName. First, we recommend using “1” as the first input argument that will save a time. Use “0” if this gives better quality images.
5.	Run the function Im2Ar with the input argument as the processed image name, e.g., xxx. The pop-up window will ask where to save the file and what is the name. Select the directory with your raw images.
6.	 Run the command c3d …….nii.gz in the directory with the text files and raw image xxx.nii.gz. The output of the command is the 44x44x44 edge-enhanced image.
7.	Open the edge-enhanced image in ITK-SNAP and adjust the contrast.
8.	
9.	
10.	
11.	c3d -int 0 Seg_CubeLRN_s05.nii.gz -resample 200x200x200% -o Seg_CubeLRN_s05_Up.nii.gz




The shell script 3D_to_1D takes the coordinates of the center of LGN as input arguments, selects the region of a size of 22x22x22 voxels around LGN, saves the selected region as NIFTI image as a reference from which the origin, orientation, and resolution are taken to reconstruct the edge-enhanced image. The script 3D_to_1D also converts the selected 3D- image into 1D- text file and saves the text file for further processing in IgorPro.
The IgorPro function Ar2Im(…) converts 1D- text file generated by the shell script 3D_to_1D  back to 3D- image for further processing in IgorPro. The necessity of the conversion of 3D- image into 1D- text by the shell script and back conversion of 1D- text into 3D- array is caused by inability of IgorPro to read NIFTI files.
The function Batch() takes no arguments. This function takes the name(s) of the raw images from the table ImName and passes the name(s) as inputs to the invoked function Reconstruction(…).
The function Reconstruction(Image, CurName, Nplanes, Nmeans, Resampling, Niterations) is invoked by function Batch(). The input arguments Image and CurName are supplied by the function Batch(). The input variable Nplanes specifies the maximum number of planes forming the set of test edges, from 1 to 3. The variable Nmeans specifies the maximum number of edges that can contribute to the value of a voxel in edge-enhanced image, from 4 to 20. The input variable Resampling specifies whether the resampling is done (”1” – “Yes”, “0” – “No”). The input variable Niterations specifies the number of consecutive edge-enhancements, either with or without resampling.
The function Im2Ar(…,2) takes edge-enhanced 3D- image and converts it to 1D- text for further processing by c3d in ITK-SNAP. The necessity of this conversion is caused by inability of IgorPro to save files in NIFTI format.
The command line window “c3d x.nii.gz -region 0x0x0vox 22x22x22vox -resample 200x200x200% -scale 0 -landmarks-to-spheres xx.txt 0.2 -o xxx.nii.gz” uses c3d command “-landmarks-to-spheres” to convert 1D- text into 3D- NIFTI image with origin and orientation matching to those of original image. The resolution of the edge-enhanced image is set as a double linear resolution of the original image.






// To get an image Cube_Im_1i, execute Batch(0,1,1). "1i" at the end stands for "1 iteration". 
// Set the first argument to either 0 (shorter time, preferred) or 1 (longer time).
// The second argument should be 1 for shapes with vertices that can be represented by 3 crossing planes (e.g., cube and triangular pyramid,
// and 4 to 20 for shapes with vertices that cannot be represented by 3 crossing planes (e.g., sphere).
// The third argument is the maximal number of iterations. To iterate the edge-enhancement 6 times, execute Batch(0,1,6).

A permanent link for downloading IgorPro experiment EdgeEnhancement.pxp is here:
https://drive.google.com/drive/folders/1zTe98Gw6bCtnQUJpOLICDqUQEz1Rieec?usp=sharing
